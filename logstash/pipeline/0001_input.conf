input {
        tcp {
                port => 5000
        }
        rabbitmq {
        host => "rabbit"
        port => 5672
        queue => "logs"
        durable => true
        passive => true
        exchange => "logs"
        user => "guest"
        password => "guest"
        tags => "rabbitmq"
    }
    beats {
        port => "5044"
    }
}
filter {
 if "rabbitmq" in [tags] {
  json {
      source => "message"
  }
  cidr{
    address => [ "%{src}" ]
    network => [ "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16" ]
    add_tag => [ "src_private"]
  }
  cidr{
    address => [ "%{dst}" ]
    network => [ "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16" ]
    add_tag => [ "dst_private"]
  }
  if "src_private" not in [tags] {
    mutate {
      add_tag => "src_public"
    }
  }
  if "src_private" in [tags] {
    mutate {
      add_field => {
           "[src_geo][longitude]" => 105.85
           "[src_geo][city_name]" => "Hanoi"
           "[src_geo][country_code3]" => "VN"
           "[src_geo][region_name]" => "Thanh Pho Ha Noi"
           "[src_geo][ip]" => "0.0.0.0"
           "[src_geo][continent_code]" => "AS"
           "[src_geo][region_code]" => "HN"
           "[src_geo][country_name]" => "Vietnam"
           "[src_geo][country_code2]" => "VN"
           "[src_geo][location][lat]" => 21.0333
           "[src_geo][location][lon]" => 105.85
           "[src_geo][latitude]" => 21.0333
           "[src_geo][timezone]" => "Asia/Ho_Chi_Minh"
      }
    }
  }
  if "dst_private" in [tags] {
    mutate {
      add_field => {
           "[dst_geo][longitude]" => 105.85
           "[dst_geo][city_name]" => "Hanoi"
           "[dst_geo][country_code3]" => "VN"
           "[dst_geo][region_name]" => "Thanh Pho Ha Noi"
           "[dst_geo][ip]" => "0.0.0.0"
           "[dst_geo][continent_code]" => "AS"
           "[dst_geo][region_code]" => "HN"
           "[dst_geo][country_name]" => "Vietnam"
           "[dst_geo][country_code2]" => "VN"
           "[dst_geo][location][lat]" => 21.0333
           "[dst_geo][location][lon]" => 105.85
           "[dst_geo][latitude]" => 21.0333
           "[dst_geo][timezone]" => "Asia/Ho_Chi_Minh"
      }
    }
  }
  geoip {
      source => "src"
      target => "src_geo"
  }
  geoip {
      source => "dst"
      target => "dst_geo"
  }
  if [hasOffense] =~ "true" {
    mutate{
      add_tag => "choice"
    }
  }
  if [dst] != 'null' {
    mutate {
      add_tag => "ignone" 
    }
  }
  else {
    mutate {
      add_field => {
           "[dst_geo][longitude]" => 105.85
           "[dst_geo][city_name]" => "Hanoi"
           "[dst_geo][country_code3]" => "VN"
           "[dst_geo][region_name]" => "Thanh Pho Ha Noi"
           "[dst_geo][ip]" => "0.0.0.0"
           "[dst_geo][continent_code]" => "AS"
           "[dst_geo][region_code]" => "HN"
           "[dst_geo][country_name]" => "Vietnam"
           "[dst_geo][country_code2]" => "VN"
           "[dst_geo][location][lat]" => 21.0333
           "[dst_geo][location][lon]" => 105.85
           "[dst_geo][latitude]" => 21.0333
           "[dst_geo][timezone]" => "Asia/Ho_Chi_Minh"
      }
    }
  }
 }
}
output {
  if "rabbitmq" in [tags] and "choice" in [tags] {
      elasticsearch {
          hosts => "elasticsearch:9200"
          user => "elastic"
          password => "changeme"
          index => "logstash-ibm-%{+YYYY.MM.dd}"
          ecs_compatibility => disabled
      }
  }
}
